\documentclass[frenchb, oneside, headings=normal]{scrartcl}

\input{lib.tex}

\usepackage{epstopdf}
\usepackage{wrapfig}
\usepackage{verbatim}
\begin{document}

\title{Projet ELEC Master 1 - Labo 5}
\subtitle{Groupe 4}
\author{Deprez Damien \and Bilal Ouachalih }
\date{18 november 2016}
\maketitle

The purpose of this lab is to correct the frequency offset and the delay due to the channel.

\section{Questions of the Pre-Lab}

\subsection{Describe what happens to the error rate of your system when the estimate for the delay in the channel is off by more than one symbol time}

First, we modified a little bit the schematic of the SlidingCorrelation.vi. In fact, we have added a controller to make an error on the delay to let us observe what happen. Here is the result\\

\begin{center}
	\begin{tabular}{c|c|c}
		 Equalizer Length & Correct delay + error & BER\\
		\hline
		 4& 3 & 0.074\\
		  & 4 & 0.5 \\
		  \hline
		 5 & 4  & 0  \\
		   & 5  & 0.488  \\
		  \hline
		6 & 5  & 0 \\
		 &  6  & 0.504 \\   
	\end{tabular}
	\captionof{table}{Effect of the error introduced in the delay on the BER}
	\label{BER_equ_length_4}
    \end{center}

\begin{comment}
\begin{figure}[!ht]
  \begin{minipage}[b]{0.48\linewidth}
        \centering \includegraphics[scale=0.45]{img/Sliding_correletaion_OFF_AWGN_5dB_shift_bit_0.png}
    \caption{Error rate for a delay+0 in AWGN}
    \label{fig1}
    \end{minipage}\hfill
    \begin{minipage}[b]{0.48\linewidth}
         \centering \includegraphics[scale=0.45]{img/Sliding_correletaion_OFF_AWGN_5dB_shift_bit_1.png}
          \caption{Error rate for a delay+1 in AWGN}
          \label{fig2}
    \end{minipage}
\end{figure}

\begin{figure}[!ht]
    \begin{minipage}[b]{0.48\linewidth}
        \centering \includegraphics[scale=0.45]{img/Sliding_correletaion_OFF_AWGN_5dB_shift_bit_2.png}
     \caption{Error rate for a delay+2 in AWGN}
     \label{fig3}
    \end{minipage}\hfill
    \begin{minipage}[b]{0.48\linewidth}
         \centering \includegraphics[scale=0.45]{img/Sliding_correletaion_OFF_AWGN_5dB_shift_bit_3.PNG}
          \caption{Error rate for a delay+3 in AWGN}
          \label{fig4}
    \end{minipage}  

\end{figure}
\begin{figure}[!ht]
    \begin{minipage}[b]{0.48\linewidth}
        \centering \includegraphics[scale=0.45]{img/Sliding_correletaion_OFF_AWGN_5dB_shift_bit_4.PNG}
     \caption{Error rate for a delay+4 in AWGN}
     \label{fig5}
    \end{minipage}\hfill
    \begin{minipage}[b]{0.48\linewidth}
         \centering \includegraphics[scale=0.45]{img/Sliding_correletaion_OFF_AWGN_5dB_shift_bit_5.PNG}
 \caption{Error rate for a delay+5 in AWGN}\label{fig6}
    \end{minipage}
\end{figure}
\end{comment}

As we can see in table \ref{BER_equ_length_4}, when the delay plus the error we intentionally add equal $L-1$, with L, the length of the equalizer, we have a BER of $\simeq 0.5$. Which means that one symbol on two is not well placed. Here is an illustration of that phenomena.

\begin{figure}[!ht]
    \begin{minipage}[b]{0.48\linewidth}
        \centering \includegraphics[scale=0.45]{img/Sliding_correletaion_OFF_AWGN_5dB_shift_bit_4.PNG}
     \caption{Error rate for a delay+4 in AWGN}
     \label{fig5}
    \end{minipage}\hfill
    \begin{minipage}[b]{0.48\linewidth}
         \centering \includegraphics[scale=0.45]{img/Sliding_correletaion_OFF_AWGN_5dB_shift_bit_5.PNG}
 \caption{Error rate for a delay+5 in AWGN}\label{fig6}
    \end{minipage}
\end{figure}

\subsection{Describe what happens to the received constellation if you do not correct for the 201 Hz frequency offset}

When we set the controller of the frequency offset on FALSE, we don't correct the error of frequency anymore, and we obtain the following result

\begin{figure}[!ht]
\centering
\includegraphics[scale=0.7]{img/test_offset_201hz_OFF.PNG}
\caption{Constellation for a frequency offset of $201 \si{\hertz}$ without correction}
\label{freq_correct_off}
\end{figure}

On the figure \ref{freq_correct_off}, we can see  that we don't have a nice constellation with 4 clear points in the 4 corner, but multiple points distributed on a portion of circle. The reason is that like the phase is the derivative of the frequency, like we have a change in frequency due to the offset, the phase will change as well and will not remain at his base value dor a QPSK modulation. That's why we have a rotation.

\subsection{What are the range of frequency offsets that you can estimate/correct using the Moose algorithm?}

If we based our observation on what is said in the book, we can determine the range of frequency to have a good result of the Moose method. In fact, we have this condition

\begin{equation}
|\epsilon| \leq \frac{1}{2*\frac{N_t}{2}} = \frac{1}{2*22} = 0.022
\label{cdt1}
\end{equation}

Or in an other form 

\begin{equation}
|f_e| \leq \frac{1}{2*T*\frac{N_t}{2}} = \frac{1}{2*1e-6*22} \simeq 22 \si{\kilo\hertz}
\label{cdt2}
\end{equation}\\

So, in theory, if we have a frequency offset greater than $22 \si{\kilo\hertz}$, the Moose method will not work anymore. In order to check if we are right, we made two simulations. The first one with a frequency offset of $10 \si{\kilo\hertz}$ and an other with $12 \si{\kilo\hertz}$, and the result is interesting.\\

\begin{figure}[!ht]
    \begin{minipage}[b]{0.48\linewidth}
        \centering \includegraphics[scale=0.45]{img/test_Offset_10k_OK_limitMooseCheck.png}
     \caption{Simulation with a frequency offset of $10 \si{\kilo\hertz}$}
     \label{MooseLimit1}
    \end{minipage}\hfill
    \begin{minipage}[b]{0.48\linewidth}
         \centering \includegraphics[scale=0.45]{img/test_Offset_12k_OK_limitMooseCheck.png}
\caption{Simulation with a frequency offset of $12 \si{\kilo\hertz}$}
 \label{MooseLimit2}
    \end{minipage}
\end{figure}

On the figure \ref{MooseLimit1} and \ref{MooseLimit2}, the result speaks of himself. Moose method doesn't work anymore above $\simeq 11 \si{\kilo\hertz}$. The reaon is that we make the correlation between a received signal with a lot of error, with a nice training sequence.

\section{Question of the Lab}

\subsection{Before changing any of the settings, calculate an average value (using five runs or so) of the inherent offset between the transmitter and receiver.}

We run five times the receiver program and we obtain the following result
 
\begin{center}
	\begin{tabular}{c|c}
		Run & Frequency offset [\si{\hertz}]\\
		\hline
		1 & 7.75\\
		2 & 12.74\\
		3 & 5.73\\
		4 & -5.26\\
		5 & -1.158\\
	\end{tabular}
\end{center}

The average offset between the transmitter and receiver introduced by the channel is $3.96$ \si{\hertz} .


\subsection{Based on the system parameters, what is the range of frequency offsets that can be estimated by your frequency offset estimation algorithm?}

Like in the previous section, we use the equation \ref{cdt1} and \ref{cdt2}, to determine the range of frequency. In the case of USRP transmission, the range of admissible frequency offset is between $0$ and $4548 \si{\hertz}$ in theory but practically, during the simulation, we see that we have error in the estimation at $2274 \si{\kilo\hertz}$ .

\subsection{Let fM be the maximum correctable frequency offset of your system (i.e., as calculated in the previous question). Modify the carrier frequency of your transmitter so that you will cause an effective offset of 0.80fM at the receiver. What is the new value of the carrier frequency at your transmitter?}

If we make a test with the USRP, and we add to the carrier frequency $0.8*f_m=0.8*2272=1818 \si{\hertz}$ (practically). The result is on figure \ref{fig8} and \ref{fig9}.

\begin{figure}[!ht]
  \begin{minipage}[b]{0.48\linewidth}
        \centering \includegraphics[scale=0.7]{img/USRP_carrieroffset_227.PNG}
    \caption{Result for a frequency offset of $227 \si{\hertz}$}
    \label{fig8}
    \end{minipage}\hfill
    \begin{minipage}[b]{0.48\linewidth}
         \centering \includegraphics[scale=0.7]{img/USRP_carrieroffset_1818.PNG}
          \caption{Result for a frequency offset of $1818 \si{\hertz}$}
          \label{fig9}
    \end{minipage}
\end{figure}

On figures \ref{fig8} and \ref{fig9}, We can observe that, more we increase the frequency offset near his maximum value, more the point on the constellation are not perfectly centered in the 4 corner of the constellation.

\begin{figure}[!ht]
    \begin{minipage}[b]{0.48\linewidth}
        \centering \includegraphics[scale=0.7]{img/USRP_value_227.PNG}
     \caption{Result data for a frequency offset of $227 \si{\hertz}$}
     \label{fig10}
    \end{minipage}\hfill
    \begin{minipage}[b]{0.48\linewidth}
         \centering \includegraphics[scale=0.7]{img/USRP_value_1818.PNG}
          \caption{Result data for a frequency offset of $1818 \si{\hertz}$}
          \label{fig11}
    \end{minipage}  
\end{figure}

The figures \ref{fig10} and \ref{fig11} show the result given by the topRX.vi, and show that, the frequency offset inserted at the transmitter is very similar to the one he measure at the receiver. Which means, that the channel itself doesn't introduce a significative error in frequency, but more in the delay.
\newpage
\section{Self referenced frame synchronization}

We are going to explore another algorithm more robust to the frequency offset. In fact, the correlation frame detector presented before, like said in previous question, "break" under large frequency offset.

First, let's consider the following received sequence

\begin{equation}
y[n] = 	\alpha \exp^{j2\pi \epsilon n}t[n-D]
\label{equ} 
\end{equation}

where $t[n]$ is the transmitted sequence, $\alpha$ is a complex scalar and D is the delay 	introduced by the channel.

\subsection{Why the self referenced frame detector works better than the correlation based detector under large frequency offsets.}

If we study the following equation

\begin{equation}
\hat{d}=argmax \frac{\sum_{n=L}^{N_t-1} y(n+d+N_t)y(n+d)^*}{\sqrt{\sum_{n=L}^{N_t-1} |y(n+d)|^2}\sqrt{\sum_{n=L}^{N_t-1} |y(n+d+N_t)|^2}}
\end{equation}\\

We can see that, if we develop the numerator, we can prove that it is independant of $\epsilon$ (the frequency offset). In fact, by the expression \ref{equ}, we have

\begin{equation}
y[n+d]^*= \alpha \exp^{-j2\pi \epsilon (n+d)}t[n+d-D]^*
\end{equation}
\begin{equation}
y[n+d+N_t]= \alpha \exp^{j2\pi \epsilon (n+d+N_t)}t[n+d+N_t-D]
\end{equation}
\begin{equation}
|y[n+d+N_t]*y[n+d]^*| = \alpha^2*|t[n+d+N_t-D]t[n+d-D]^*|
\label{equ2}
\end{equation} 	

We take the module of $y[n+d+N_t]*y[n+d]^*$ because y can be complex. And in the equation \ref{equ2}, we have no more $\epsilon$ appearing.
At the end, we can conclude that, for this method, the estimation of the delay will not depend of the frequency offset. 

\subsection{Name three impairments in a real wireless system which impact the accuracy of the correlation based detection method.}

The 3 impairements are 

\begin{itemize}

\item If we have a \textbf{frequency offset}, the correlation of the received training sequence will be less effective.

\item \textbf{The noise} can make the calcul of the correlation difficult because, we will receive a sequence corrupted by noise.

\item If we have \textbf{intersymbol interference (ISI)}, the correlation will be corrupted because we will have imperfection in the symbol of the received signal y of equation \ref{equ}.
\end{itemize}

\subsection{Under large frequency offsets, the correlation based detector “breaks”. What property of the training sequence breaks down under large frequency offsets?}

We know that the training sequence has a very good correlation. But, with the correlation based detector, like we make the correlation between a not perfect received signal (see equation \ref{equ2}) with a perfect training sequence, the correlation will not be good at each value of y, which explain a maximum frequency of $11$\si{\kilo\hertz} instead of $22$\si{\kilo\hertz}.
 
\subsection{In the self referenced frame synchronization method, is it still critical that the periodic training sequence have good autocorrelation properties? If so, why?}

It's no more critical that the training sequence must still have good autocorrelation properties. In fact, we correlate two same signals just shifted of $N_t$ one from each other, so like the training sequence is periodic, we will always have a result for the correlation of 1 (see equation \ref{equ2}). When we try the new algorithm with larger offset, around $22.5$ \si{\kilo\hertz}. So, we have removed the limit of $11$ \si{\kilo\hertz} introduced by the sliding correlator, and we have obtained the offset we calculated before.

\begin{figure}[!ht]
    \begin{minipage}[b]{0.48\linewidth}
        \centering \includegraphics[scale=0.75]{img/NewMethodLimit_22k.PNG}
     \caption{Measured data for a frequency offset of $22 \si{\kilo\hertz}$}
     \label{fig10}
    \end{minipage}\hfill
    \begin{minipage}[b]{0.48\linewidth}
         \centering \includegraphics[scale=0.75]{img/NewMethodLimit_23k}
          \caption{Mesured data for a frequency offset of $23 \si{\kilo\hertz}$}
          \label{fig11}
    \end{minipage}  
\end{figure}

\end{document}
